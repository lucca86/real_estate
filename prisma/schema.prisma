generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  SUPERVISOR
  VENDEDOR
}

enum PropertyStatus {
  ACTIVO
  ALQUILADO
  VENDIDO
  ELIMINADO
  RESERVADO
  EN_REVISION
}

enum TransactionType {
  VENTA
  ALQUILER
  VENTA_ALQUILER
  ALQUILER_OPCION_COMPRA
}

enum AppointmentStatus {
  PENDIENTE
  CONFIRMADA
  COMPLETADA
  CANCELADA
}

enum RentalPeriod {
  MENSUAL
  SEMANAL
  DIARIO
}

enum PropertyLabel {
  NUEVA
  DESTACADA
  REBAJADA
}

model User {
  id                String    @id @default(cuid())
  email             String    @unique
  name              String
  password          String
  role              UserRole  @default(VENDEDOR)
  avatar            String?
  phone             String?
  twoFactorEnabled  Boolean   @default(false)
  twoFactorSecret   String?
  isActive          Boolean   @default(true)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  properties        Property[]
  sessions          Session[]
  appointments      Appointment[]
}

model Session {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Property {
  id                String          @id @default(cuid())
  title             String
  description       String          @db.Text
  adrema            String?         // Added optional Adrema field
  propertyTypeId    String?
  propertyType      PropertyType?   @relation(fields: [propertyTypeId], references: [id])
  transactionType   TransactionType
  status            PropertyStatus  @default(ACTIVO)
  rentalPeriod      RentalPeriod?   // Período de renta (Mensual, Semanal, Diario)
  
  // Ubicación
  address           String
  neighborhoodId    String?
  neighborhood      Neighborhood?   @relation(fields: [neighborhoodId], references: [id])
  cityId            String?
  city              City?           @relation(fields: [cityId], references: [id])
  provinceId        String?
  province          Province?       @relation(fields: [provinceId], references: [id])
  countryId         String?
  country           Country?        @relation(fields: [countryId], references: [id])
  zipCode           String?
  latitude          Float?
  longitude         Float?
  
  // Características
  bedrooms          Int?
  bathrooms         Int?
  parkingSpaces     Int?
  area              Float           // Área en m²
  lotSize           Float?          // Tamaño del lote en m²
  yearBuilt         Int?
  
  // Precios
  price             Float
  pricePerM2        Float?
  rentalPrice       Float?
  currency          String          @default("USD")
  
  // Características adicionales
  features          String[]        // Array de características (piscina, jardín, etc.)
  amenities         String[]        // Amenidades (gimnasio, seguridad, etc.)
  
  // Media
  images            String[]        // URLs de imágenes
  videos            String[]        // URLs de videos
  virtualTour       String?         // URL del tour virtual
  
  // WordPress Integration
  wordpressId       Int?            @unique
  syncedAt          DateTime?
  
  // Owner relationship
  ownerId           String?
  owner             Owner?          @relation(fields: [ownerId], references: [id])
  
  // Metadata
  views             Int             @default(0)
  propertyLabel     PropertyLabel?  // Nueva, Destacada, Rebajada
  syncToWordPress   Boolean         @default(true) // Control de sincronización con WordPress
  published         Boolean         @default(true)
  createdById       String
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  
  createdBy         User            @relation(fields: [createdById], references: [id])
  appointments      Appointment[]
  
  @@index([status])
  @@index([propertyTypeId])
  @@index([transactionType])
  @@index([neighborhoodId])
  @@index([cityId])
  @@index([provinceId])
  @@index([countryId])
  @@index([wordpressId])
  @@index([ownerId])
  @@index([propertyLabel])
}

model Owner {
  id                String      @id @default(cuid())
  name              String
  email             String      @unique
  phone             String
  secondaryPhone    String?
  address           String?
  cityId            String?
  city              City?       @relation(fields: [cityId], references: [id])
  provinceId        String?
  province          Province?   @relation(fields: [provinceId], references: [id])
  countryId         String?
  country           Country?    @relation(fields: [countryId], references: [id])
  idNumber          String?
  taxId             String?
  notes             String?     @db.Text
  isActive          Boolean     @default(true)
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  
  properties        Property[]
  
  @@index([email])
  @@index([phone])
  @@index([cityId])
  @@index([provinceId])
  @@index([countryId])
}

model Client {
  id                String      @id @default(cuid())
  name              String
  email             String      @unique
  phone             String
  secondaryPhone    String?
  address           String?
  cityId            String?
  city              City?       @relation(fields: [cityId], references: [id])
  provinceId        String?
  province          Province?   @relation(fields: [provinceId], references: [id])
  countryId         String?
  country           Country?    @relation(fields: [countryId], references: [id])
  occupation        String?
  budget            Float?
  preferredPropertyTypeId String?
  preferredPropertyType   PropertyType? @relation("ClientPreferredPropertyType", fields: [preferredPropertyTypeId], references: [id])
  preferredTransactionType TransactionType?
  notes             String?     @db.Text
  source            String?
  isActive          Boolean     @default(true)
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  
  appointments      Appointment[]
  
  @@index([email])
  @@index([phone])
  @@index([preferredPropertyTypeId])
  @@index([cityId])
  @@index([provinceId])
  @@index([countryId])
}

model PropertyType {
  id          String     @id @default(cuid())
  name        String     @unique
  description String?
  isActive    Boolean    @default(true)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  
  properties  Property[]
  clients     Client[]   @relation("ClientPreferredPropertyType")
  
  @@index([name])
}

model Appointment {
  id                String            @id @default(cuid())
  propertyId        String
  clientId          String
  agentId           String
  scheduledAt       DateTime
  duration          Int               @default(60) // Duración en minutos
  status            AppointmentStatus @default(PENDIENTE)
  notes             String?           @db.Text
  reminderSent      Boolean           @default(false)
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  
  property          Property          @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  client            Client            @relation(fields: [clientId], references: [id], onDelete: Cascade)
  agent             User              @relation(fields: [agentId], references: [id])
  
  @@index([propertyId])
  @@index([clientId])
  @@index([agentId])
  @@index([scheduledAt])
  @@index([status])
}

model Country {
  id         String     @id @default(cuid())
  name       String     @unique
  code       String     @unique // ISO code: AR, BR, UY, etc.
  isActive   Boolean    @default(true)
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt
  
  provinces  Province[]
  properties Property[]
  owners     Owner[]
  clients    Client[]
  
  @@index([code])
}

model Province {
  id         String     @id @default(cuid())
  name       String
  countryId  String
  isActive   Boolean    @default(true)
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt
  
  country    Country    @relation(fields: [countryId], references: [id], onDelete: Cascade)
  cities     City[]
  properties Property[]
  owners     Owner[]
  clients    Client[]
  
  @@unique([name, countryId])
  @@index([countryId])
}

model City {
  id            String         @id @default(cuid())
  name          String
  provinceId    String
  isActive      Boolean        @default(true)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  
  province      Province       @relation(fields: [provinceId], references: [id], onDelete: Cascade)
  neighborhoods Neighborhood[]
  properties    Property[]
  owners        Owner[]
  clients       Client[]
  
  @@unique([name, provinceId])
  @@index([provinceId])
}

model Neighborhood {
  id         String     @id @default(cuid())
  name       String
  cityId     String
  isActive   Boolean    @default(true)
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt
  
  city       City       @relation(fields: [cityId], references: [id], onDelete: Cascade)
  properties Property[]
  
  @@unique([name, cityId])
  @@index([cityId])
}
